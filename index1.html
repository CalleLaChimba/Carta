
<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Carte finale — Autour de Calle La Chimba (Santa Ana, CR)</title>
  <meta name="description" content="Carte interactive finale : Loisirs & tourisme, Commerces, Santé (hôpitaux + pharmacies), Accès & transports, Écoles privées, Banques, Coworking, Services publics — autour de Calle La Chimba (Santa Ana, CR)." />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root{--bg:#0b1220;--panel:#0f172a;--muted:#cbd5e1;--ring:#60a5fa;--card:#0b1020}
    html,body{height:100%;margin:0;background:#0b1220;color:#e5e7eb;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{display:grid;grid-template-columns:420px 1fr;gap:14px;height:100%;padding:14px}
    @media (max-width:1100px){.wrap{grid-template-columns:1fr;grid-template-rows:480px 1fr}}
    .panel{background:var(--panel);border-radius:18px;display:flex;flex-direction:column;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    header{padding:18px;border-bottom:1px solid rgba(148,163,184,.18)}
    h1{font-size:22px;margin:0 0 4px}
    .addr{font-size:13px;color:var(--muted)}
    #map{height:100%;border-radius:18px;box-shadow:0 12px 40px rgba(0,0,0,.35);outline:1px solid rgba(148,163,184,.18)}
    .chips{display:flex;flex-wrap:wrap;gap:8px;padding:12px 16px}
    .chip{display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:#0c1326;border:1px solid #2a355b;cursor:pointer;font-weight:700;font-size:13px}
    .chip.active{outline:2px solid var(--ring)}
    .dot{width:12px;height:12px;border-radius:999px;border:2px solid #fff}
    .legend{display:grid;grid-template-columns:1fr 1fr;gap:8px;padding:0 16px 6px 16px;color:#e5e7eb;font-size:13px}
    .legend .item{display:flex;align-items:center;gap:10px;font-weight:600}
    .list{overflow:auto;padding:6px 12px 12px 12px}
    .card{background:var(--card);border:1px solid rgba(148,163,184,.2);border-radius:14px;padding:12px;margin:8px 4px;display:grid;grid-template-columns:1fr auto;gap:8px}
    .card h3{margin:0;font-size:16px}
    .pill{font-size:11.5px;color:#fff;padding:4px 9px;border-radius:999px;align-self:start}
    .meta{font-size:12.5px;color:#aab4c0}
    .cta{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
    .btn{border:1px solid rgba(148,163,184,.25);background:#0f162d;color:#e2e7eb;border-radius:10px;padding:7px 10px;font-size:12.5px;text-decoration:none}
    .btn:hover{border-color:#60a5fa}
    .tools{padding:12px 16px;border-top:1px solid rgba(148,163,184,.18)}
    .tools input, .tools textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #2a355b;background:#0b1020;color:#e2e7eb}
    .tools small{color:#9aa3b8}
    .inline{display:flex;gap:8px;align-items:center;margin-top:8px}
    .copy{cursor:pointer;border:1px solid rgba(148,163,184,.25);padding:6px 10px;border-radius:8px;background:#0f162d;color:#fff}
    details summary{cursor:pointer}
  
    /* On-map labels: white text for readability */
    

/* === Readability fixes for left panel === */
.legend{ color:#ffffff !important; }
.legend .item span{ color:#ffffff !important; }
.chip{ color:#ffffff !important; }
.card h3{ color:#ffffff !important; }
.pill{
  /* keep white text but boost legibility on bright hues (ex: jaune transports) */
  color:#ffffff !important;
  text-shadow: 0 1px 2px rgba(0,0,0,.9), 0 0 6px rgba(0,0,0,.7);
  background-image: linear-gradient(rgba(0,0,0,.18), rgba(0,0,0,.18));
  background-blend-mode: multiply;
}
/* optional: dull the very light badge colors a bit more on hover/focus */
.card:hover .pill{ background-image: linear-gradient(rgba(0,0,0,.22), rgba(0,0,0,.22)); }

</style>
</head>
<body>
<div class="wrap">
  <aside class="panel">
    <header>
      <h1>Carte finale — Calle La Chimba</h1>
      <div class="addr">Santa Ana (San José), Costa Rica · Maison · Calle La Chimba, Uruca / Río Oro</div>
    </header>
    <div class="chips" id="chips"></div>
    <div class="legend" id="legend"></div>
    <div class="list" id="poi-list"></div>
    <div class="tools">
      <details open>
        <summary><b>Partage & intégration</b> (lien, WhatsApp, email, QR & iframe)</summary>
        <div style="display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px">
          <div>
            <label for="shareUrl"><small>URL à partager (défaut : l’adresse actuelle de la page)</small></label>
            <div class="inline">
              <input id="shareUrl" type="url" placeholder="https://votre-domaine.com/carte-santa-ana.html">
              <button id="copyLink" class="copy" type="button">Copier</button>
            </div>
          </div>
          <div class="inline">
            <button id="updateShare" class="btn" type="button">Mettre à jour lien & QR</button>
            <a id="wa" class="btn" href="#" target="_blank" rel="noopener">Ouvrir WhatsApp</a>
            <a id="mailto" class="btn" href="#">Ouvrir Email</a>
          </div>
          <div id="qrcode" style="margin-top:6px"></div>
          <div>
            <label for="iframeCode"><small>Code d’intégration (iframe)</small></label>
            <textarea id="iframeCode" rows="4" readonly></textarea>
          </div>
          <small>⚠️ Pour que le QR fonctionne pour tout le monde, l’URL doit être publique (http/https). Un lien <code>file://</code> ne marchera que sur votre propre appareil.</small>
        </div>
      </details>
    </div>
  </aside>
  <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
  const property = { lat: 9.9251, lng: -84.1989, name: "Maison – Calle La Chimba" };

  const categories = {
    loisirs:   { label: "Loisirs & tourisme", color: "#ef4444" },
    commerces: { label: "Commerces", color: "#22c55e" },
    sante:     { label: "Santé (hôpitaux + pharmacies)", color: "#a855f7" },
    transports:{ label: "Accès & transports", color: "#f59e0b" },
    ecoles:    { label: "Écoles privées", color: "#3b82f6" },
    banques:   { label: "Banques", color: "#14b8a6" },
    coworking: { label: "Coworking", color: "#06b6d4" },
    services:  { label: "Services publics", color: "#6b7280" }
  };

  const pois = [
    // Loisirs & tourisme
    { name: "Hacienda La Chimba (café, canopy, sentiers)", cat: "loisirs", lat: 9.9167, lng: -84.2000, site: "https://lachimbacr.com/", desc: "Plantation de café, Mantra Trail, tyroliennes, restaurants." },
    { name: "Santa Ana Country Club (SACC)", cat: "loisirs", lat: 9.95390, lng: -84.18390, site: "https://santaanacountryclubcr.com/", desc: "Club privé : sports, fitness, restauration." },
    { name: "Valle del Sol — Golf 18 trous", cat: "loisirs", lat: 9.950263, lng: -84.212714, site: "https://vallesol.com/", desc: "Golf public (Par 72)." },

    // Commerces
    { name: "PriceSmart Santa Ana", cat: "commerces", lat: 9.938507, lng: -84.200424, site: "https://www.pricesmart.com/", desc: "Hypermarché type Costco (adhésion)." },
    { name: "Auto Mercado — Río Oro", cat: "commerces", lat: 9.9382991, lng: -84.1988922, site: "https://automercado.cr/", desc: "Supermarché premium de quartier." },
    { name: "Walmart Escazú", cat: "commerces", lat: 9.93496, lng: -84.12921, site: "https://www.walmart.co.cr/", desc: "Grande surface à 10–15 min env." },
    { name: "Momentum Lindora", cat: "commerces", lat: 9.953333, lng: -84.195278, site: "https://www.momentumlindora.com/", desc: "Restos, commerces, ofiplaza." },
    { name: "Terrazas Lindora", cat: "commerces", lat: 9.95722, lng: -84.19662, site: "https://www.terrazaslindora.com/", desc: "Restaurants & services." },
    { name: "Multiplaza Escazú", cat: "commerces", lat: 9.94433, lng: -84.15049, site: "https://www.multiplaza.com/", desc: "Le plus grand mall de l’ouest." },

    // Santé (hôpitaux + pharmacies)
    { name: "Hospital CIMA San José (Escazú)", cat: "sante", lat: 9.939643, lng: -84.144329, site: "https://hospitalcima.com/", desc: "Hôpital privé reconnu (JCI)." },
    { name: "Hospital Metropolitano – Lindora", cat: "sante", lat: 9.9534, lng: -84.19041, site: "https://metropolitanocr.com/", desc: "Urgences & spécialités." },
    { name: "Hospital Clínica Bíblica — Sede Santa Ana", cat: "sante", lat: 9.94601, lng: -84.18841, site: "https://www.clinicabiblica.com/es/santa-ana", desc: "Hôpital privé 24/7." },
    { name: "Farmacia Fischel — Santa Ana Town Center", cat: "sante", lat: 9.93379, lng: -84.19048, site: "https://www.fischelenlinea.com/farmacias", desc: "Pharmacie (Fischel)." },
    { name: "Farmacia Sucre — Momentum Lindora", cat: "sante", lat: 9.95385, lng: -84.19469, site: "https://sucreenlinea.com/", desc: "Pharmacie (drive-thru)." },

    // Écoles privées
    { name: "UWC Costa Rica (United World College)", cat: "ecoles", lat: 9.94727, lng: -84.19604, site: "https://www.uwccostarica.cr/", desc: "Lycée international (IB)." },
    { name: "International Saint Jude School (Pozos, Santa Ana)", cat: "ecoles", lat: 9.951070, lng: -84.203430, site: "https://www.stjude.ed.cr/", desc: "École privée bilingue." },
    { name: "Blue Valley School (Guachipelín, Escazú)", cat: "ecoles", lat: 9.953611, lng: -84.158889, site: "https://www.bluevalleyschool.org/", desc: "École privée (IB)." },
    { name: "Country Day School (Hacienda Espinal)", cat: "ecoles", lat: 9.950360, lng: -84.248540, site: "https://www.nordangliaeducation.com/cds-costa-rica/campus", desc: "École privée internationale." },
    { name: "GSD International School (La Guácima)", cat: "ecoles", lat: 9.949840, lng: -84.262400, site: "https://www.gsdinternationalschool.cr/", desc: "École privée." },

    // Accès & transports
    { name: "Entrée Ruta 27 – Próspero Fernández (Santa Ana)", cat: "transports", lat: 9.93719, lng: -84.22011, site: "https://globalviaruta27.com/", desc: "Accès rapide San José & côtes Pacifique." },
    { name: "Aéroport Tobías Bolaños (Pavas, SYQ)", cat: "transports", lat: 9.95706, lng: -84.13980, site: "", desc: "Aéroport urbain (vols domestiques & privés)." },
    { name: "Aéroport International Juan Santamaría (SJO)", cat: "transports", lat: 9.99386, lng: -84.20882, site: "https://sjoairport.com/", desc: "Aéroport principal de San José." },

    // Banques
    { name: "Scotiabank — Bulevar Lindora", cat: "banques", lat: 9.953169, lng: -84.194541, site: "https://www.scotiabankcr.com/horarios-sucursales/", desc: "Banque commerciale." },
    { name: "BCR — Vistana Oeste (Lindora)", cat: "banques", lat: 9.950951, lng: -84.193715, site: "https://www.bancobcr.com/", desc: "Banco de Costa Rica." },
    { name: "Banco Popular — Lindora", cat: "banques", lat: 9.949981, lng: -84.193110, site: "https://www.bancopopular.fi.cr/", desc: "Banco Popular." },
    { name: "Davivienda — Plaza Lindora", cat: "banques", lat: 9.949444, lng: -84.193056, site: "https://www.davivienda.cr/", desc: "Davivienda." },
    { name: "Banco LAFISE — Momentum Lindora", cat: "banques", lat: 9.953850, lng: -84.194690, site: "https://www.lafise.com/cr", desc: "Banco LAFISE." },
    { name: "Banco Nacional — Lindora", cat: "banques", lat: 9.957220, lng: -84.196620, site: "https://www.bncr.fi.cr/", desc: "Banco Nacional." },

    // Coworking
    { name: "Republic Workspace — Santa Ana Town Center", cat: "coworking", lat: 9.93412, lng: -84.18725, site: "https://republic.cr/santa-ana/", desc: "Coworking & bureaux, centre-ville." },
    { name: "The Train — Business Hub (Arbórea Flats, Río Oro)", cat: "coworking", lat: 9.93865, lng: -84.19880, site: "https://thetrain.biz/", desc: "Bureaux & coworking premium." },

    // Services publics
    { name: "Municipalidad de Santa Ana (Mairie) — site officiel", cat: "services", lat: 9.931988, lng: -84.175979, site: "https://www.santaana.go.cr/", desc: "Mairie de Santa Ana." }
  ].map(p => ({...p, gmaps:`https://www.google.com/maps/search/?api=1&query=${p.lat},${p.lng}`}));

  const map = L.map('map', { zoomControl: false });
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution:'&copy; OpenStreetMap' }).addTo(map);
  L.control.zoom({ position: 'bottomright' }).addTo(map);

  const homeIcon = L.divIcon({ className:'', html:`<div style="background:#60a5fa;width:18px;height:18px;border:2px solid white;border-radius:50%;box-shadow:0 2px 10px rgba(0,0,0,.4)"></div>`});
  const homeMarker = L.marker([property.lat, property.lng], { icon: homeIcon }).addTo(map).bindPopup(`<b>${property.name}</b>`);

  const catColor = k => categories[k]?.color || '#fff';
  const layerGroup = L.layerGroup().addTo(map);
  const chips = document.getElementById('chips');
  const legend = document.getElementById('legend');
  const list = document.getElementById('poi-list');
  const active = new Set(Object.keys(categories));

  function dot(color){ return `<span class="dot" style="background:${color}"></span>`; }
  Object.entries(categories).forEach(([key, val]) => {
    const chip = document.createElement('button');
    chip.className = 'chip active';
    chip.dataset.key = key;
    chip.innerHTML = `${dot(val.color)} ${val.label}`;
    chip.onclick = () => {
      if (active.has(key)) { active.delete(key); chip.classList.remove('active'); }
      else { active.add(key); chip.classList.add('active'); }
      draw();
    };
    chips.appendChild(chip);

    const li = document.createElement('div');
    li.className = 'item';
    li.innerHTML = `${dot(val.color)} <span>${val.label}</span>`;
    legend.appendChild(li);
  });

  function toRad(d){return d*Math.PI/180}
  function haversine(a,b){
    const R=6371000, dLat=toRad(b.lat-a.lat), dLng=toRad(b.lng-a.lng);
    const s=Math.sin(dLat/2)**2 + Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLng/2)**2;
    return 2*R*Math.asin(Math.sqrt(s));
  }
  function fmtKm(m){return (m/1000).toFixed(1).replace('.',',')+' km'}

  function draw(){
    layerGroup.clearLayers();
    const filtered = pois.filter(p=>active.has(p.cat));
    filtered.forEach(p => {
      const marker = L.circleMarker([p.lat, p.lng], {
        radius: 9, color: catColor(p.cat), fillColor: catColor(p.cat), fillOpacity: .95, weight: 2
      }).addTo(layerGroup).bindPopup(
        `<div style="font-size:15px;font-weight:800;margin-bottom:4px">${p.name}</div>`+
        `<div style="font-size:12.5px;opacity:.9;margin-bottom:8px">${categories[p.cat]?.label || p.cat}</div>`+
        (p.desc?`<div style="font-size:13px;margin-bottom:8px">${p.desc}</div>`:'')+
        `<div style="display:flex;gap:8px;flex-wrap:wrap">`+
        `<a href="${p.gmaps}" target="_blank" rel="noopener" class="btn" style="padding:6px 8px">Google Maps</a>`+
        (p.site?`<a href="${p.site}" target="_blank" rel="noopener" class="btn" style="padding:6px 8px">Site</a>`:'')+
        `</div>`
      );
    
      // White-text label for readability
      });
    const latlngs = [[property.lat, property.lng], ...filtered.map(p=>[p.lat,p.lng])];
    if (latlngs.length>1){ map.fitBounds(L.latLngBounds(latlngs).pad(0.2)); }

    const items = filtered.map(p=>({p, d:haversine({lat:property.lat,lng:property.lng},{lat:p.lat,lng:p.lng})})).sort((a,b)=>a.d-b.d);
    list.innerHTML = items.map(({p,d}) => {
      const c = categories[p.cat];
      const waze = `https://waze.com/ul?ll=${p.lat}%2C${p.lng}&navigate=yes`;
      return `<div class='card'>
        <div>
          <h3>${p.name}</h3>
          <div class='meta'>${c.label}${p.desc?` · ${p.desc}`:''}</div>
          <div class='meta'>Distance : ${fmtKm(d)}</div>
          <div class='cta'>
            <a class='btn' href='${p.gmaps}' target='_blank' rel='noopener'>Google Maps</a>
            <a class='btn' href='${waze}' target='_blank' rel='noopener'>Waze</a>
            ${p.site?`<a class='btn' href='${p.site}' target='_blank' rel='noopener'>Site</a>`:''}
          </div>
        </div>
        <span class='pill' style='background:${c.color}'>${c.label}</span>
      </div>`;
    }).join('');
  }
  draw();

  // Partage
  const shareUrl = document.getElementById('shareUrl');
  const iframeCode = document.getElementById('iframeCode');
  const wa = document.getElementById('wa');
  const mailto = document.getElementById('mailto');
  const qr = document.getElementById('qrcode');
  const updateShare = document.getElementById('updateShare');
  const copyLink = document.getElementById('copyLink');

  function updateSharing(link){
    iframeCode.value = `<iframe src="${link}" width="100%" height="650" style="border:0;border-radius:12px" allowfullscreen loading="lazy"></iframe>`;
    const msg = `Hola! Mira el mapa interactivo con todo lo que hay alrededor de la casa en Santa Ana (escuelas, bancos, centros comerciales, salud, etc.): ${link}`;
    const waUrl = `https://wa.me/?text=${encodeURIComponent(msg)}`;
    const mailSub = encodeURIComponent("Mapa interactivo — Casa en Santa Ana");
    const mailBody = encodeURIComponent(`Bonjour,\n\nVoici la carte interactive des atouts autour de la maison (écoles, commerces, santé, banques, etc.) :\n${link}\n\nBonne journée !`);
    wa.href = waUrl;
    mailto.href = `mailto:?subject=${mailSub}&body=${mailBody}`;
    qr.innerHTML = "";
    if (window.QRCode) new QRCode(qr, { text: link, width: 160, height: 160 });
  }

  const defaultUrl = window.location.href;
  shareUrl.value = defaultUrl;
  updateSharing(defaultUrl);

  updateShare.addEventListener('click', () => {
    const link = (shareUrl.value || '').trim() || defaultUrl;
    updateSharing(link);
  });
  copyLink.addEventListener('click', () => {
    const link = (shareUrl.value || '').trim() || defaultUrl;
    navigator.clipboard.writeText(link).then(()=>{ copyLink.textContent = "Copié !"; setTimeout(()=>copyLink.textContent="Copier",1500); });
  });
</script>
</body>
</html>
